<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.inspur.gcloud.mc.core.dao.EnvelopeDao">

    <resultMap type="com.inspur.gcloud.mc.core.data.Envelope" id="envelopeResultMap">
    	<id property="id" column="id" />
        <collection property="message" column="message_id" select="com.inspur.gcloud.mc.core.dao.MessageDao.getMessageById" ></collection>
    </resultMap>
	
	<!-- 通过databaseId指定数据库的类型 -->
    <select id="findList" resultMap="envelopeResultMap" parameterType="map">
        SELECT 
            id,
            message_id, 
            sender_id,
            receiver_id,
            send_time,
            read_time,
            send_state
            
        FROM mc_envelope  
        <where>
        	<if test="messageType != null and messageType != '' ">
			 	message_type = '${messageType}'
			</if>
			<if test="receiverId != null and receiverId != '' ">
			 	and receiver_id = '${receiverId}'
			</if>
			<if test="senderId != null and senderId != '' ">
			 	and sender_id = '${senderId}'
			</if>
			<if test="sendState != null and sendState != '' ">
				and send_state = '${sendState}'
			</if>
        </where>
        <if test="orderfield != null" >
         order by 
        	<choose>    
                <when test="orderfield == 'senderId'">    
                    sender_id ${orderdir} 
                </when>  
                 <when test="orderfield == 'receiverId'">    
                    receiver_id ${orderdir} 
                </when>  
                <otherwise> 
               		send_time ${orderdir}   
                </otherwise>    
            </choose>    
        </if>
    </select>
	
	<select id="getByParams" parameterType="map" resultMap="envelopeResultMap">
		select 
		message_id,
		message_Type,
		sender_Id,
		receiver_Id,
		send_time,
		create_time,
		receive_state,
		send_State,
		m_id,
		message_level,
		message_topic,
		message_content
		from mc_envelope,mc_message
		<where>
			message_id=m_id
			<if test="receiveState != null and receiveState!= '' ">
			 	and receive_state like '%${receiveState}%'
			</if>
			<if test="senderId != null and senderId != '' ">
			 	and sender_Id like '%${senderId}%'
			</if>
			<if test="receiverId != null and receiverId != '' ">
			 	and receiver_Id like '%${receiverId}%'
			</if>
			<if test="sendState != null and sendState != '' ">
				and send_State like '%${sendState}%'
			</if>
			<if test="messageType != null and messageType != '' ">
				and message_Type like '%${messageType}%'
			</if>
			<if test="messageTopic != null and messageTopic !='' ">
				and message_topic like '%${messageTopic}%'
			</if>
		</where>				
	</select>
	<update id="changeState" parameterType="string">
		update mc_envelope 
		<set>
			<if test="boxType = 'in' or boxType = 'draft'">
				receive_state = '2'
			</if>
			<if test="boxType = 'out'">
				send_state = '2'
			</if>
		</set>
		<where>
			id = '${id}'
		</where>
	</update>

</mapper>